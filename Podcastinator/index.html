<html>
  <head>
    <script src="config.js"></script>
    <script>
      var today = function() {
        var local = new Date();
        local.setMinutes(local.getMinutes() - local.getTimezoneOffset());
        return local.toJSON().slice(0, 10);
      }

var sha1 = function(msg) {
  function rotl(n,s) { return n<<s|n>>>32-s; };
  function tohex(i) { for(var h="", s=28;;s-=4) { h+=(i>>>s&0xf).toString(16); if(!s) return h; } };
  var H0=0x67452301, H1=0xEFCDAB89, H2=0x98BADCFE, H3=0x10325476, H4=0xC3D2E1F0, M=0x0ffffffff; 
  var i, t, W=new Array(80), ml=msg.length, wa=new Array();
  msg += fcc(0x80);
  while(msg.length%4) msg+=fcc(0);
  for(i=0;i<msg.length;i+=4) wa.push(msg.cca(i)<<24|msg.cca(i+1)<<16|msg.cca(i+2)<<8|msg.cca(i+3));
  while(wa.length%16!=14) wa.push(0);
  wa.push(ml>>>29),wa.push((ml<<3)&M);
  for( var bo=0;bo<wa.length;bo+=16 ) {
    for(i=0;i<16;i++) W[i]=wa[bo+i];
    for(i=16;i<=79;i++) W[i]=rotl(W[i-3]^W[i-8]^W[i-14]^W[i-16],1);
    var A=H0, B=H1, C=H2, D=H3, E=H4;
    for(i=0 ;i<=19;i++) t=(rotl(A,5)+(B&C|~B&D)+E+W[i]+0x5A827999)&M, E=D, D=C, C=rotl(B,30), B=A, A=t;
    for(i=20;i<=39;i++) t=(rotl(A,5)+(B^C^D)+E+W[i]+0x6ED9EBA1)&M, E=D, D=C, C=rotl(B,30), B=A, A=t;
    for(i=40;i<=59;i++) t=(rotl(A,5)+(B&C|B&D|C&D)+E+W[i]+0x8F1BBCDC)&M, E=D, D=C, C=rotl(B,30), B=A, A=t;
    for(i=60;i<=79;i++) t=(rotl(A,5)+(B^C^D)+E+W[i]+0xCA62C1D6)&M, E=D, D=C, C=rotl(B,30), B=A, A=t;
    H0=H0+A&M;H1=H1+B&M;H2=H2+C&M;H3=H3+D&M;H4=H4+E&M;
  }
  return tohex(H0)+tohex(H1)+tohex(H2)+tohex(H3)+tohex(H4);
}
    
    var empty = function(x) {
      return !x || x == "";
    }
    
    var validate = function() {
      var form = document.forms.form;
      if (empty(form.title.value)) {
        alert("Please specify the title");
        return false;
      } else if (empty(form.speaker.options[form.speaker.selectedIndex].value)) {
        alert("Please specify the speaker");
        return false;
      } else if (empty(form.service.options[form.service.selectedIndex].value)) {
        alert("Please specify the service");
        return false;
      } else if (empty(form.date.value)) {
        alert("Please specify the date");
        return false;
      } else if (form.file.files.length == 0) {
        alert("Please specify the MP3 file");
        return false;
      } else if (sha1(form.password.value) != '434cba2ad97cb292e1f0cfbe9a3c24c245cbd269') {
        alert("Invalid password");
        return false;
       } else {
        return true;
      }
    }
    
    var addOptions = function(select, array) {
      for (var i = 0; i < array.length; ++i) {
        var option = document.createElement('option');
        option.text = array[i];
        option.value = array[i];
        select.options[i] = option;
      }
    };
    
    window.onload = function() {
      document.forms.form.date.value = today();
      
      document.getElementById('email').href = 'mailto:' + config.email;
      document.getElementById('email').innerText = config.email;
      
      addOptions(document.forms.form.speaker, config.speakers);
      addOptions(document.forms.form.service, config.services);
      addOptions(document.forms.form.location, config.locations);
    }
    </script>
  </head>
  <body>
    <p>Problems?  Please contact <a id="email" href="#">?</a> for help.</p>
    <form name="form" action="confirm.html" onsubmit="return validate()">
      <table>
        <tr><td>Title:</td><td><input type="text" name="title"/></td></tr>
        <tr><td>Speaker:</td><td><select name="speaker"></select></td></tr>
        <tr><td>Service:</td><td><select name="service"></select></td></tr>
        <tr><td>Location:</td><td><select name="location"></select></td></tr>
        <tr><td>Date:</td><td><input type="date" name="date"/></td></tr>
        <tr><td>MP3:</td><td><input type="file" name="file" accept="audio/mpeg"/></td></tr>
        <tr><td>Password:</td><td><input type="password" name="password"/></td></tr>
        <tr><td></td><td><input type="submit" value="Next"/></td></tr>
      </table>
    </form>
    <p id="log"></p>
  </body>
</html>
